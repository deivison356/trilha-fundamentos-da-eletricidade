<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Prova Online com Calculadora</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f5f5f5;
  }
  #telaLogin, #telaProva {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #telaLogin {
    background: #fff;
  }
  #telaLogin.active, #telaProva.active {
    display: flex;
  }
  #telaLogin:not(.active), #telaProva:not(.active) {
    display: none;
  }
  #iframeForm {
    width: 80vw;
    height: 85vh;
    border: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
  }
  #cronometro {
    font-size: 18px;
    margin-bottom: 10px;
    color: #222;
    font-weight: bold;
  }
  #alerta {
    color: #d32f2f;
    font-weight: bold;
    margin-bottom: 10px;
    display: none;
  }
  /* Calculadora maior com botão minimizar */
  #calculadora {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 250px;
    background: #222;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
    color: white;
    font-family: Arial, sans-serif;
    z-index: 11000;
    transition: height 0.3s ease;
  }
  #calcHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  #calcHeader .title {
    font-weight: bold;
    font-size: 16px;
  }
  #btnMinimizar {
    background: #444;
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 18px;
    line-height: 1;
  }
  #calcDisplay {
    width: 100%;
    padding: 8px;
    font-size: 18px;
    border-radius: 4px;
    border: none;
    margin-bottom: 8px;
    text-align: right;
    background: #333;
    color: white;
    user-select: none;
  }
  #calculadora.minimized #calcBody {
    display: none;
  }
  #calculadora.minimized {
    height: auto;
    padding-bottom: 8px;
  }
  #calcBody .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }
  #calcBody button {
    flex: 1;
    margin: 0 3px;
    padding: 10px 0;
    font-size: 16px;
    background: #444;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
  }
  #calcBody button:hover {
    background: #666;
  }
</style>
</head>
<body>

<div id="telaLogin" class="active">
  <h2>Digite a senha para iniciar a prova</h2>
  <input type="password" id="senha" placeholder="trilhaDDMMAAAA" />
  <button id="btnIniciar">Iniciar Prova</button>
</div>

<div id="telaProva">
  <div id="cronometro">Tempo restante: 60:00</div>
  <div id="alerta">⚠️ Você saiu da aba ou da tela cheia. Penalização aplicada.</div>
  <iframe id="iframeForm" src="https://docs.google.com/forms/d/e/1FAIpQLSfZB9lfPqm5MUZC7UpaU2sYHxF4-Tdi-HIbKTyXLKW2bjDRpA/viewform?usp=dialog" allowfullscreen></iframe>

  <div id="calculadora">
    <div id="calcHeader">
      <div class="title">Calculadora</div>
      <button id="btnMinimizar" title="Minimizar">–</button>
    </div>
    <div id="calcBody">
      <input type="text" id="calcDisplay" readonly />
      <div class="row">
        <button onclick="calcPress('7')">7</button>
        <button onclick="calcPress('8')">8</button>
        <button onclick="calcPress('9')">9</button>
        <button onclick="calcPress('+')">+</button>
      </div>
      <div class="row">
        <button onclick="calcPress('4')">4</button>
        <button onclick="calcPress('5')">5</button>
        <button onclick="calcPress('6')">6</button>
        <button onclick="calcPress('-')">−</button>
      </div>
      <div class="row">
        <button onclick="calcPress('1')">1</button>
        <button onclick="calcPress('2')">2</button>
        <button onclick="calcPress('3')">3</button>
        <button onclick="calcPress('*')">×</button>
      </div>
      <div class="row">
        <button onclick="calcPress('0')">0</button>
        <button onclick="calcPress('.')">.</button>
        <button onclick="calcBackspace()">←</button>
        <button onclick="calcPress('/')">÷</button>
      </div>
      <div class="row">
        <button onclick="calcClear()" style="flex:1; margin-right: 5px;">C</button>
        <button onclick="calcCalculate()" style="flex:1;">=</button>
      </div>
    </div>
  </div>
</div>

<audio id="somPenalidade" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="somErro" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
<audio id="somAviso" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
  const tempoTotal = 60 * 60; // 60 minutos
  const penalidadeTempo = 20 * 60; // 20 minutos
  let tempoRestante = tempoTotal;
  let contadorPenalidades = 0;
  let intervaloCronometro;

  const telaLogin = document.getElementById('telaLogin');
  const telaProva = document.getElementById('telaProva');
  const cronometro = document.getElementById('cronometro');
  const alerta = document.getElementById('alerta');
  const iframeForm = document.getElementById('iframeForm');
  const btnIniciar = document.getElementById('btnIniciar');
  const senhaInput = document.getElementById('senha');
  const somPenalidade = document.getElementById('somPenalidade');
  const somErro = document.getElementById('somErro');
  const somAviso = document.getElementById('somAviso');
  const calculadora = document.getElementById('calculadora');
  const btnMinimizar = document.getElementById('btnMinimizar');
  const calcBody = document.getElementById('calcBody');

  btnIniciar.addEventListener('click', () => {
    const senhaDigitada = senhaInput.value.trim();
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    const senhaCorreta = 'trilha' + dia + mes + ano;

    if (senhaDigitada === senhaCorreta) {
      iniciarProva();
      entrarEmTelaCheia();
    } else {
      alert('Senha incorreta!');
    }
  });

  function iniciarProva() {
    telaLogin.classList.remove('active');
    telaProva.classList.add('active');
    atualizarCronometro();
    intervaloCronometro = setInterval(() => {
      tempoRestante--;
      atualizarCronometro();
      if (tempoRestante <= 0) {
        finalizarProva('Tempo esgotado!');
      }
    }, 1000);
  }

  function atualizarCronometro() {
    const minutos = Math.floor(tempoRestante / 60);
    const segundos = tempoRestante % 60;
    cronometro.textContent = `Tempo restante: ${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`;

    // Exibir alerta e som quando restar 10 minutos
    if (tempoRestante === 10 * 60) {
      alerta.textContent = '⚠️ Faltam apenas 10 minutos para o término da prova.';
      alerta.style.display = 'block';
      somAviso.play();
      setTimeout(() => { alerta.style.display = 'none'; }, 5000);
    }
  }

  function entrarEmTelaCheia() {
    const el = document.documentElement;
    if (el.requestFullscreen) {
      el.requestFullscreen().catch(() => {
        alert('Não foi possível ativar o modo tela cheia.');
      });
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      aplicarPenalidade();
    }
  });

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      aplicarPenalidade();
    }
  });

  function aplicarPenalidade() {
    if (contadorPenalidades >= 3) return; // Já finalizou

    contadorPenalidades++;
    tempoRestante -= penalidadeTempo;
    if (tempoRestante < 0) tempoRestante = 0;
    alerta.textContent = `⚠️ Você saiu da aba ou da tela cheia. Penalização ${contadorPenalidades}/3 aplicada (-20 min).`;
    alerta.style.display = 'block';
    somPenalidade.play();

    if (contadorPenalidades >= 3) {
      setTimeout(() => finalizarProva('Você excedeu o número máximo de penalidades. A prova será encerrada.'), 3000);
    } else {
      setTimeout(() => { alerta.style.display = 'none'; }, 4000);
    }
  }

  function finalizarProva(mensagem) {
    clearInterval(intervaloCronometro);
    alerta.style.display = 'none';
    cronometro.textContent = mensagem;
    somErro.play();

    // Tenta fechar a aba, se não conseguir redireciona para uma página de bloqueio (ou pode usar alertar)
    setTimeout(() => {
      if (!window.close()) {
        // Caso window.close não funcione, redireciona para página de bloqueio (altere o link se quiser)
        window.location.href = 'about:blank';
        // ou uma página customizada: window.location.href = 'https://seusite.com/bloqueio.html';
      }
    }, 2000);
  }

  // Calculadora
  let calcExpression = '';
  const calcDisplay = document.getElementById('calcDisplay');

  function calcPress(valor) {
    calcExpression += valor;
    calcDisplay.value = calcExpression;
  }

  function calcClear() {
    calcExpression = '';
    calcDisplay.value = '';
  }

  function calcBackspace() {
    calcExpression = calcExpression.slice(0, -1);
    calcDisplay.value = calcExpression;
  }

  function calcCalculate() {
    try {
      let expressao = calcExpression.replace(/×/g, '*').replace(/÷/g, '/');
      let resultado = Function('"use strict"; return (' + expressao + ')')();
      calcExpression = resultado.toString();
      calcDisplay.value = calcExpression;
    } catch {
      calcDisplay.value = 'Erro';
      calcExpression = '';
    }
  }

  // Botão minimizar calculadora
  btnMinimizar.addEventListener('click', () => {
    calculadora.classList.toggle('minimized');
    if(calculadora.classList.contains('minimized')) {
      btnMinimizar.textContent = '+';
      btnMinimizar.title = "Maximizar";
    } else {
      btnMinimizar.textContent = '–';
      btnMinimizar.title = "Minimizar";
    }
  });
</script>

</body>
</html>
